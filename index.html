<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>キャッシュバック口座情報入力フォーム</title>

  <!-- Material UI CSS (CDN) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* リセットとベーススタイル */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 16px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    /* ヘッダー */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    /* メインコンテンツ */
    .main {
      padding: 24px;
    }

    /* ステップインジケーター */
    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 32px;
      position: relative;
    }

    .steps::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      flex: 1;
    }

    .step-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: white;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      color: #999;
      margin-bottom: 8px;
    }

    .step.active .step-circle {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .step.completed .step-circle {
      background: #4caf50;
      border-color: #4caf50;
      color: white;
    }

    .step-label {
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .step.active .step-label {
      color: #667eea;
      font-weight: 500;
    }

    /* セクション */
    .section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 500;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title .material-icons {
      color: #667eea;
    }

    /* 確認情報カード */
    .info-card {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #666;
      font-size: 14px;
    }

    .info-value {
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    /* フォームフィールド */
    .form-field {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }

    .form-label .required {
      color: #f44336;
      margin-left: 4px;
    }

    .form-label .optional {
      color: #999;
      font-size: 12px;
      font-weight: 400;
      margin-left: 4px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-input.error {
      border-color: #f44336;
    }

    .form-input:disabled {
      background: #f5f5f5;
      color: #999;
    }

    /* 検索可能なセレクト */
    .search-select {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      padding-right: 40px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      pointer-events: none;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #667eea;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .search-results.show {
      display: block;
    }

    .search-result-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: #f5f5f5;
    }

    .search-result-item.selected {
      background: #e3f2fd;
    }

    .result-code {
      font-size: 12px;
      color: #999;
      margin-right: 8px;
    }

    .result-name {
      font-size: 14px;
      color: #333;
    }

    .result-kana {
      font-size: 12px;
      color: #666;
      margin-left: 8px;
    }

    .no-results {
      padding: 16px;
      text-align: center;
      color: #999;
      font-size: 14px;
    }

    /* ラジオボタングループ */
    .radio-group {
      display: flex;
      gap: 16px;
    }

    .radio-option {
      flex: 1;
    }

    .radio-option input[type="radio"] {
      display: none;
    }

    .radio-label {
      display: block;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .radio-option input[type="radio"]:checked + .radio-label {
      border-color: #667eea;
      background: #e3f2fd;
      color: #667eea;
      font-weight: 500;
    }

    /* チェックボックス */
    .checkbox-field {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: #fff3e0;
      border-radius: 8px;
      border: 2px solid #ff9800;
      margin-bottom: 24px;
    }

    .checkbox-field input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      cursor: pointer;
    }

    .checkbox-label {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
    }

    .checkbox-label a {
      color: #667eea;
      text-decoration: none;
    }

    .checkbox-label a:hover {
      text-decoration: underline;
    }

    /* ヘルプテキスト */
    .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .error-text {
      font-size: 12px;
      color: #f44336;
      margin-top: 4px;
      display: none;
    }

    .error-text.show {
      display: block;
    }

    /* ボタン */
    .button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .button-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .button-secondary:hover {
      background: #f5f5f5;
    }

    /* 自動保存インジケーター */
    .autosave-indicator {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #4caf50;
      color: white;
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .autosave-indicator.show {
      opacity: 1;
    }

    /* 確認画面 */
    .confirmation-section {
      display: none;
    }

    .confirmation-section.show {
      display: block;
    }

    .confirm-item {
      padding: 16px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .confirm-item:last-child {
      border-bottom: none;
    }

    .confirm-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    .confirm-value {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .button-group .button {
      flex: 1;
    }

    /* 警告バナー */
    .warning-banner {
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
    }

    .warning-banner .material-icons {
      color: #f57c00;
      font-size: 24px;
    }

    .warning-content {
      flex: 1;
    }

    .warning-title {
      font-size: 14px;
      font-weight: 500;
      color: #e65100;
      margin-bottom: 8px;
    }

    .warning-text {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .warning-example {
      font-size: 13px;
      color: #333;
      background: white;
      padding: 8px;
      border-radius: 4px;
      margin-top: 8px;
    }

    .warning-example strong {
      color: #f57c00;
    }

    /* 完了画面 */
    .completion-section {
      display: none;
      text-align: center;
      padding: 40px 24px;
    }

    .completion-section.show {
      display: block;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: #4caf50;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .success-icon .material-icons {
      font-size: 48px;
      color: white;
    }

    .completion-title {
      font-size: 24px;
      font-weight: 500;
      color: #333;
      margin-bottom: 16px;
    }

    .completion-message {
      font-size: 14px;
      color: #666;
      line-height: 1.8;
      margin-bottom: 32px;
    }

    /* ローディング */
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* エラー画面 */
    .error-section {
      display: none;
      text-align: center;
      padding: 40px 24px;
    }

    .error-section.show {
      display: block;
    }

    .error-icon {
      width: 80px;
      height: 80px;
      background: #f44336;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .error-icon .material-icons {
      font-size: 48px;
      color: white;
    }

    .error-title {
      font-size: 24px;
      font-weight: 500;
      color: #333;
      margin-bottom: 16px;
    }

    .error-message {
      font-size: 14px;
      color: #666;
      line-height: 1.8;
    }

    /* レスポンシブ */
    @media (max-width: 600px) {
      body {
        padding: 0;
      }

      .container {
        border-radius: 0;
        min-height: 100vh;
      }

      .header h1 {
        font-size: 18px;
      }

      .main {
        padding: 16px;
      }

      .radio-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ヘッダー -->
    <div class="header">
      <h1>キャッシュバック口座情報入力<br><small style="font-size: 14px; font-weight: 400;">Cashback Bank Account Registration</small></h1>
      <p>振込先の口座情報をご入力ください<br><small style="opacity: 0.8;">Please enter your bank account information</small></p>
    </div>

    <!-- メインコンテンツ -->
    <div class="main">
      <!-- 初期ローディング -->
      <div class="loading show" id="initialLoading">
        <div class="spinner"></div>
        <p style="color: #666;">読み込み中... / Loading...</p>
      </div>

      <!-- エラー画面 -->
      <div class="error-section" id="errorSection">
        <div class="error-icon">
          <span class="material-icons">error_outline</span>
        </div>
        <h2 class="error-title" id="errorTitle">エラー / Error</h2>
        <p class="error-message" id="errorMessage">問題が発生しました。</p>
      </div>

      <!-- メインフォームコンテナ -->
      <div id="formContainer" style="display: none;">
        <!-- ステップインジケーター -->
        <div class="steps">
          <div class="step active" id="step1">
            <div class="step-circle">1</div>
            <div class="step-label">情報入力<br><small style="font-size: 10px;">Input</small></div>
          </div>
          <div class="step" id="step2">
            <div class="step-circle">2</div>
            <div class="step-label">確認<br><small style="font-size: 10px;">Confirm</small></div>
          </div>
          <div class="step" id="step3">
            <div class="step-circle">3</div>
            <div class="step-label">完了<br><small style="font-size: 10px;">Done</small></div>
          </div>
        </div>

        <!-- 入力画面 -->
        <div id="inputSection">
          <!-- 確認情報 -->
          <div class="section">
            <div class="section-title">
              <span class="material-icons">info</span>
              ご確認ください / Please Confirm
            </div>
            <div class="info-card">
              <div class="info-row">
                <span class="info-label">お名前 / Name</span>
                <span class="info-value" id="displayName">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">電話番号 / Phone</span>
                <span class="info-value" id="displayPhone">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">キャッシュバック金額 / Amount</span>
                <span class="info-value" id="displayAmount">-</span>
              </div>
            </div>
          </div>

          <!-- メールアドレス -->
          <div class="section">
            <div class="form-field">
              <label class="form-label">
                メールアドレス / Email Address
                <span class="required">*</span>
              </label>
              <input
                type="email"
                class="form-input"
                id="email"
                placeholder="example@email.com"
                autocomplete="email"
              >
              <div class="help-text">振込完了通知やエラー発生時の連絡に使用します<br><small style="color: #888;">Used for transfer completion notifications and error alerts</small></div>
              <div class="error-text" id="emailError">正しいメールアドレスを入力してください / Please enter a valid email address</div>
            </div>
          </div>

          <!-- 口座情報 -->
          <div class="section">
            <div class="section-title">
              <span class="material-icons">account_balance</span>
              振込先口座情報 / Bank Account Information
            </div>

            <!-- 銀行名 -->
            <div class="form-field">
              <label class="form-label">
                銀行名 / Bank Name（カナ入力）
                <span class="required">*</span>
              </label>
              <div class="search-select">
                <input
                  type="text"
                  class="search-input"
                  id="bankSearch"
                  placeholder="銀行名をカナで入力（例：ミズホ）"
                  autocomplete="off"
                  inputmode="katakana"
                >
                <span class="material-icons search-icon">search</span>
                <div class="search-results" id="bankResults"></div>
              </div>
              <div class="help-text">カナで入力すると候補が表示されます<br><small style="color: #888;">Type in Katakana to see suggestions</small></div>
              <div class="error-text" id="bankError">銀行を選択してください / Please select a bank</div>
            </div>

            <!-- ゆうちょ銀行アラート -->
            <div id="yuuchoAlert" style="display: none; background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
              <div style="display: flex; gap: 12px;">
                <span class="material-icons" style="color: #f57c00; font-size: 24px;">warning</span>
                <div style="flex: 1;">
                  <div style="font-weight: 500; color: #e65100; margin-bottom: 8px;">
                    ゆうちょ銀行をご利用の方へ<br>
                    <small style="color: #888;">For Japan Post Bank users</small>
                  </div>
                  <div style="font-size: 13px; color: #666; line-height: 1.6; margin-bottom: 12px;">
                    通帳に記載の「記号・番号」と振込用の「店名・口座番号」は異なります。<br>
                    <small style="color: #888;">The "Symbol/Number" on your passbook differs from the transfer account number.</small>
                  </div>
                  <div style="font-size: 13px; color: #666; margin-bottom: 12px;">
                    下記リンクで変換してから入力してください：<br>
                    <small style="color: #888;">Please convert using the link below:</small>
                  </div>
                  <a href="https://www.jp-bank.japanpost.jp/kojin/sokin/furikomi/kouza/kj_sk_fm_kz_1.html" target="_blank" rel="noopener" style="display: inline-flex; align-items: center; gap: 4px; color: #1976d2; text-decoration: none; font-size: 14px; font-weight: 500;">
                    <span class="material-icons" style="font-size: 18px;">open_in_new</span>
                    記号番号から振込用口座番号を調べる
                  </a>
                </div>
              </div>
            </div>

            <!-- 支店名 -->
            <div class="form-field">
              <label class="form-label">
                支店名 / Branch Name（カナ入力）
                <span class="required">*</span>
              </label>
              <div class="search-select">
                <input
                  type="text"
                  class="search-input"
                  id="branchSearch"
                  placeholder="支店名をカナで入力（例：トウキヨウ）"
                  autocomplete="off"
                  inputmode="katakana"
                  disabled
                >
                <span class="material-icons search-icon">search</span>
                <div class="search-results" id="branchResults"></div>
              </div>
              <div class="help-text" id="branchHelp">まず銀行を選択してください / Please select a bank first</div>
              <div class="error-text" id="branchError">支店を選択してください / Please select a branch</div>
            </div>

            <!-- 預金種目 -->
            <div class="form-field">
              <label class="form-label">
                預金種目 / Account Type
                <span class="required">*</span>
              </label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" name="accountType" id="typeOrdinary" value="ordinary" checked>
                  <label for="typeOrdinary" class="radio-label">普通預金<br><small style="font-size: 11px;">Savings</small></label>
                </div>
                <div class="radio-option">
                  <input type="radio" name="accountType" id="typeCurrent" value="current">
                  <label for="typeCurrent" class="radio-label">当座預金<br><small style="font-size: 11px;">Checking</small></label>
                </div>
              </div>
            </div>

            <!-- 口座番号 -->
            <div class="form-field">
              <label class="form-label">
                口座番号 / Account Number
                <span class="required">*</span>
              </label>
              <input
                type="text"
                class="form-input"
                id="accountNumber"
                placeholder="1234567"
                maxlength="7"
                inputmode="numeric"
                autocomplete="off"
              >
              <div class="help-text">7桁の数字を入力してください<br><small style="color: #888;">Enter 7 digits (auto-padded with zeros)</small></div>
              <div class="error-text" id="accountNumberError">7桁の数字を入力してください / Please enter 7 digits</div>
            </div>

            <!-- 口座名義 -->
            <div class="form-field">
              <label class="form-label">
                口座名義 / Account Holder Name（カナ）
                <span class="required">*</span>
              </label>
              <input
                type="text"
                class="form-input"
                id="accountName"
                placeholder="ヤマダ タロウ"
                autocomplete="off"
                inputmode="katakana"
              >
              <div class="help-text">全角カタカナで入力してください。姓と名の間にスペースを入れてください（例：ヤマダ タロウ）<br><small style="color: #888;">Enter in Katakana with a space between family and given name</small></div>
              <div class="error-text" id="accountNameError">全角カタカナで入力してください / Please enter in Katakana</div>
            </div>
          </div>

          <!-- 個人情報取扱同意 -->
          <div class="checkbox-field">
            <input type="checkbox" id="consent">
            <label for="consent" class="checkbox-label">
              <a href="#" target="_blank">個人情報の取扱いに関する同意事項</a>を確認し、同意します<br>
              <small style="color: #666;">I have read and agree to the privacy policy</small>
            </label>
          </div>

          <!-- 確認ボタン -->
          <button class="button button-primary" id="confirmButton" disabled>
            <span class="material-icons">check_circle</span>
            確認画面へ / Confirm
          </button>
        </div>

        <!-- 確認画面 -->
        <div class="confirmation-section" id="confirmationSection">
          <div class="section">
            <div class="section-title">
              <span class="material-icons">fact_check</span>
              入力内容の確認 / Confirmation
            </div>
            <p style="color: #666; font-size: 14px; margin-bottom: 24px;">
              以下の内容でよろしければ「送信する」ボタンを押してください<br>
              <small style="color: #888;">Please review and click "Submit" if correct</small>
            </p>

            <!-- 警告バナー（スペースなし口座名義） -->
            <div id="accountNameWarning" style="display: none;">
              <div class="warning-banner">
                <span class="material-icons">warning</span>
                <div class="warning-content">
                  <div class="warning-title">確認してください / Please Check</div>
                  <div class="warning-text">
                    口座名義にスペースが含まれていません。<br>
                    正式な口座名義は、姓と名の間にスペースを入れる必要があります。<br>
                    <small style="color: #888;">Account name has no space. Usually a space is required between family and given name.</small>
                  </div>
                  <div class="warning-example">
                    例：ヤマダ タロウ、タナカ ハナコ、サトウ ケンイチ
                  </div>
                  <div style="font-size: 12px; color: #999; margin-top: 8px;">
                    修正する場合は「戻る」ボタンを押してください。<br>
                    <small>Click "Back" to edit, or submit as is if no space is needed.</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="info-card">
              <div class="confirm-item">
                <div class="confirm-label">お名前 / Name</div>
                <div class="confirm-value" id="confirmName"></div>
              </div>
              <div class="confirm-item">
                <div class="confirm-label">電話番号 / Phone</div>
                <div class="confirm-value" id="confirmPhone"></div>
              </div>
              <div class="confirm-item">
                <div class="confirm-label">メールアドレス / Email</div>
                <div class="confirm-value" id="confirmEmail"></div>
              </div>
              <div class="confirm-item">
                <div class="confirm-label">キャッシュバック金額 / Amount</div>
                <div class="confirm-value" id="confirmAmount"></div>
              </div>
              <div class="confirm-item">
                <div class="confirm-label">銀行名 / Bank</div>
                <div class="confirm-value" id="confirmBank"></div>
              </div>
              <div class="confirm-item">
                <div class="confirm-label">支店名 / Branch</div>
                <div class="confirm-value" id="confirmBranch"></div>
              </div>
              <div class="confirm-item">
                <div class="confirm-label">預金種目 / Account Type</div>
                <div class="confirm-value" id="confirmAccountType"></div>
              </div>
              <div class="confirm-item">
                <div class="confirm-label">口座番号 / Account No.</div>
                <div class="confirm-value" id="confirmAccountNumber"></div>
              </div>
              <div class="confirm-item">
                <div class="confirm-label">口座名義 / Account Holder</div>
                <div class="confirm-value" id="confirmAccountName"></div>
              </div>
            </div>

            <div class="button-group">
              <button class="button button-secondary" id="backButton">
                <span class="material-icons">arrow_back</span>
                戻る / Back
              </button>
              <button class="button button-primary" id="submitButton">
                <span class="material-icons">send</span>
                送信する / Submit
              </button>
            </div>
          </div>
        </div>

        <!-- 送信中 -->
        <div class="loading" id="loadingSection">
          <div class="spinner"></div>
          <p style="color: #666;">送信中... / Submitting...</p>
        </div>

        <!-- 完了画面 -->
        <div class="completion-section" id="completionSection">
          <div class="success-icon">
            <span class="material-icons">check</span>
          </div>
          <h2 class="completion-title">送信完了 / Submitted</h2>
          <p class="completion-message">
            口座情報の登録が完了しました。<br>
            振込完了後、ご登録いただいたメールアドレスに通知をお送りします。<br>
            <br>
            <small style="color: #888;">Your bank account information has been registered.<br>
            You will receive an email notification when the transfer is complete.</small>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- 自動保存インジケーター -->
  <div class="autosave-indicator" id="autosaveIndicator">
    <span class="material-icons" style="font-size: 16px;">cloud_done</span>
    <span>自動保存しました / Auto-saved</span>
  </div>

  <script>
    // 設定（静的ホスティング用）
    const GAS_URL = 'https://script.google.com/a/macros/terracom.co.jp/s/AKfycbwl__0N9PAeTRFpXBHYVNVe72vGsTLGdJTaRyeqMHejPiLNbzxGfHTuDy2L8ojSFzpi/exec';
    // Cloudflare Worker URL
    const WORKER_URL = 'https://cb-form-proxy.ilucartip.workers.dev';
    const BASE_URL = GAS_URL;
    const TOKEN = new URLSearchParams(window.location.search).get('token') || '';
    const ENCODED_DATA = new URLSearchParams(window.location.search).get('d') || '';

    // グローバル変数
    let receptionData = null;
    let banksCache = [];
    let branchesCache = {};
    let selectedBank = null;
    let selectedBranch = null;
    let formData = {};

    // JSONP リクエスト関数（CORS回避用）
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const script = document.createElement('script');

        // タイムアウト設定（10秒）
        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error('JSONP request timeout'));
        }, 10000);

        function cleanup() {
          clearTimeout(timeout);
          delete window[callbackName];
          if (script.parentNode) {
            script.parentNode.removeChild(script);
          }
        }

        window[callbackName] = function(data) {
          cleanup();
          resolve(data);
        };

        script.onerror = function() {
          cleanup();
          reject(new Error('JSONP request failed'));
        };

        const separator = url.includes('?') ? '&' : '?';
        script.src = url + separator + 'callback=' + callbackName;
        document.head.appendChild(script);
      });
    }

    // エラーメッセージ定義
    const ERROR_MESSAGES = {
      'INVALID_TOKEN_FORMAT': {
        title: '無効なURL / Invalid URL',
        message: 'このURLは正しくありません。<br>QRコードを再度スキャンしてください。<br><small style="color: #888;">This URL is invalid. Please scan the QR code again.</small>'
      },
      'TOKEN_NOT_FOUND': {
        title: '受付情報が見つかりません / Not Found',
        message: 'この受付は見つかりません。<br>店舗スタッフにお問い合わせください。<br><small style="color: #888;">This registration was not found. Please contact staff.</small>'
      },
      'TOKEN_INVALIDATED': {
        title: 'このQRコードは無効です / Invalid QR Code',
        message: 'このQRコードは再発行されたため無効になりました。<br>新しいQRコードをご利用ください。<br><small style="color: #888;">This QR code has been reissued. Please use the new one.</small>'
      },
      'TOKEN_ALREADY_USED': {
        title: '登録済み / Already Registered',
        message: '口座情報は既に登録されています。<br>ご不明な点は店舗スタッフにお問い合わせください。<br><small style="color: #888;">Bank account is already registered. Please contact staff if you have questions.</small>'
      },
      'TOKEN_EXPIRED': {
        title: '有効期限切れ / Expired',
        message: 'このQRコードの有効期限が切れています。<br>店舗にてQRコードを再発行してもらってください。<br><small style="color: #888;">This QR code has expired. Please ask staff to reissue it.</small>'
      },
      'DEFAULT': {
        title: 'エラー / Error',
        message: '問題が発生しました。<br>しばらく経ってから再度お試しください。<br><small style="color: #888;">An error occurred. Please try again later.</small>'
      }
    };

    // Base64デコード関数（UTF-8対応）
    function decodeReceptionData(encoded) {
      try {
        // Base64 → バイナリ文字列 → UTF-8デコード
        const binaryString = atob(encoded);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        const decoded = new TextDecoder('utf-8').decode(bytes);
        const data = JSON.parse(decoded);
        return {
          name: data.n,
          phone: data.p,
          amount: data.a,
          storeName: data.s,
          email: data.e
        };
      } catch (e) {
        console.error('Failed to decode reception data:', e);
        return null;
      }
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', async function() {
      if (!TOKEN || !ENCODED_DATA) {
        showError('INVALID_TOKEN_FORMAT');
        return;
      }

      try {
        // URLから受付データをデコード（API呼び出し不要）
        receptionData = decodeReceptionData(ENCODED_DATA);

        if (!receptionData) {
          showError('INVALID_TOKEN_FORMAT');
          return;
        }

        // トークン検証（Worker経由でGAS APIを呼び出し）
        try {
          const validateResponse = await fetch(`${WORKER_URL}/validate?token=${encodeURIComponent(TOKEN)}`);
          const validateResult = await validateResponse.json();

          if (!validateResult.valid) {
            // トークンが無効な場合はエラー画面を表示
            showError(validateResult.error || 'DEFAULT');
            return;
          }
        } catch (validateError) {
          console.warn('Token validation failed, continuing with form:', validateError);
          // 検証に失敗しても、フォームは表示する（送信時に再検証される）
        }

        // 受付データを表示
        document.getElementById('displayName').textContent = receptionData.name + ' 様';
        document.getElementById('displayPhone').textContent = formatPhoneNumber(receptionData.phone);
        document.getElementById('displayAmount').textContent = receptionData.amount.toLocaleString() + '円';

        // メールアドレスがあればプリフィル
        if (receptionData.email) {
          document.getElementById('email').value = receptionData.email;
        }

        // 銀行データは遅延読み込み（フォーカス時に取得）
        // await loadBanks(); // 初期ロードでは読み込まない

        // localStorageから復元
        restoreFormData();

        // イベントリスナー設定
        setupEventListeners();

        // バリデーション
        validateForm();

        // 初期ローディングを非表示
        document.getElementById('initialLoading').classList.remove('show');
        document.getElementById('formContainer').style.display = 'block';

      } catch (error) {
        console.error('Init error:', error);
        showError('DEFAULT');
      }
    });

    // エラー表示
    function showError(errorCode) {
      const errorInfo = ERROR_MESSAGES[errorCode] || ERROR_MESSAGES['DEFAULT'];
      document.getElementById('errorTitle').textContent = errorInfo.title;
      document.getElementById('errorMessage').innerHTML = errorInfo.message;
      document.getElementById('initialLoading').classList.remove('show');
      document.getElementById('errorSection').classList.add('show');
    }

    // 銀行データを取得（zengin-codeから直接取得）
    async function loadBanks() {
      try {
        const response = await fetch('https://raw.githubusercontent.com/zengin-code/source-data/master/data/banks.json');
        const data = await response.json();
        // オブジェクト形式から配列形式に変換
        banksCache = Object.values(data).map(bank => ({
          code: bank.code,
          name: bank.name,
          kana: bank.kana
        }));
      } catch (error) {
        console.error('Failed to load banks:', error);
        banksCache = [];
      }
    }

    // 支店データを取得（zengin-codeから直接取得）
    async function loadBranches(bankCode) {
      if (branchesCache[bankCode]) {
        return branchesCache[bankCode];
      }

      try {
        const response = await fetch(`https://raw.githubusercontent.com/zengin-code/source-data/master/data/branches/${bankCode}.json`);
        if (!response.ok) {
          branchesCache[bankCode] = [];
          return [];
        }
        const data = await response.json();
        // オブジェクト形式から配列形式に変換
        branchesCache[bankCode] = Object.values(data).map(branch => ({
          code: branch.code,
          name: branch.name,
          kana: branch.kana
        }));
        return branchesCache[bankCode];
      } catch (error) {
        console.error('Failed to load branches:', error);
        branchesCache[bankCode] = [];
      }
      return [];
    }

    // イベントリスナー設定
    function setupEventListeners() {
      // 銀行検索
      const bankSearch = document.getElementById('bankSearch');
      let isBankComposing = false;

      bankSearch.addEventListener('compositionstart', function() {
        isBankComposing = true;
      });

      bankSearch.addEventListener('compositionend', function(e) {
        isBankComposing = false;
        e.target.value = convertToKana(e.target.value);
        searchBanks(e.target.value);
      });

      bankSearch.addEventListener('input', function(e) {
        if (!isBankComposing) {
          e.target.value = convertToKana(e.target.value);
          searchBanks(e.target.value);
        }
      });

      bankSearch.addEventListener('focus', async function() {
        // 銀行データを遅延読み込み
        if (banksCache.length === 0) {
          this.placeholder = '銀行データを読み込み中...';
          await loadBanks();
          this.placeholder = '銀行名を入力（カナ可）';
        }
        if (this.value) {
          searchBanks(this.value);
        }
      });

      // 支店検索
      const branchSearch = document.getElementById('branchSearch');
      let isBranchComposing = false;

      branchSearch.addEventListener('compositionstart', function() {
        isBranchComposing = true;
      });

      branchSearch.addEventListener('compositionend', function(e) {
        isBranchComposing = false;
        e.target.value = convertToKana(e.target.value);
        if (selectedBank) {
          searchBranches(e.target.value);
        }
      });

      branchSearch.addEventListener('input', function(e) {
        if (!isBranchComposing) {
          e.target.value = convertToKana(e.target.value);
          if (selectedBank) {
            searchBranches(e.target.value);
          }
        }
      });

      branchSearch.addEventListener('focus', function() {
        if (this.value && selectedBank) {
          searchBranches(this.value);
        }
      });

      // 口座番号の自動ゼロ埋め
      const accountNumber = document.getElementById('accountNumber');
      accountNumber.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        validateForm();
        autoSave();
      });

      accountNumber.addEventListener('blur', function(e) {
        if (e.target.value) {
          e.target.value = e.target.value.padStart(7, '0');
        }
      });

      // 口座名義の自動カナ変換
      const accountName = document.getElementById('accountName');
      let isAccountNameComposing = false;

      accountName.addEventListener('compositionstart', function() {
        isAccountNameComposing = true;
      });

      accountName.addEventListener('compositionend', function(e) {
        isAccountNameComposing = false;
        let value = convertToKana(e.target.value);
        value = value.replace(/ /g, '　');
        e.target.value = value;
        validateForm();
        autoSave();
      });

      accountName.addEventListener('input', function(e) {
        if (!isAccountNameComposing) {
          let value = convertToKana(e.target.value);
          value = value.replace(/ /g, '　');
          e.target.value = value;
          validateForm();
          autoSave();
        }
      });

      accountName.addEventListener('blur', function(e) {
        let value = e.target.value;
        value = value.replace(/ /g, '　');
        e.target.value = value;
        validateForm();
        autoSave();
      });

      // その他の入力フィールド
      document.getElementById('email').addEventListener('input', function() {
        validateForm();
        autoSave();
      });

      document.querySelectorAll('input[name="accountType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          validateForm();
          autoSave();
        });
      });

      document.getElementById('consent').addEventListener('change', validateForm);

      // ボタン
      document.getElementById('confirmButton').addEventListener('click', showConfirmation);
      document.getElementById('backButton').addEventListener('click', backToInput);
      document.getElementById('submitButton').addEventListener('click', submitForm);

      // クリック外で検索結果を閉じる
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-select')) {
          document.getElementById('bankResults').classList.remove('show');
          document.getElementById('branchResults').classList.remove('show');
        }
      });
    }

    // カナ変換関数
    function convertToKana(text) {
      // ひらがな → カタカナ
      let result = text.replace(/[ぁ-ん]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) + 0x60);
      });

      // 半角カナ → 全角カナ
      result = result.replace(/[ｦ-ﾟ]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) + 0xFEC0);
      });

      result = result.toUpperCase();

      return result;
    }

    // 検索用にカナを正規化（全角カナに統一）
    function normalizeForSearch(text) {
      // ひらがな → カタカナ
      let result = text.replace(/[ぁ-ん]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) + 0x60);
      });

      // 半角カナ → 全角カナ
      const halfToFull = {
        'ｦ': 'ヲ', 'ｧ': 'ァ', 'ｨ': 'ィ', 'ｩ': 'ゥ', 'ｪ': 'ェ', 'ｫ': 'ォ',
        'ｬ': 'ャ', 'ｭ': 'ュ', 'ｮ': 'ョ', 'ｯ': 'ッ', 'ｰ': 'ー',
        'ｱ': 'ア', 'ｲ': 'イ', 'ｳ': 'ウ', 'ｴ': 'エ', 'ｵ': 'オ',
        'ｶ': 'カ', 'ｷ': 'キ', 'ｸ': 'ク', 'ｹ': 'ケ', 'ｺ': 'コ',
        'ｻ': 'サ', 'ｼ': 'シ', 'ｽ': 'ス', 'ｾ': 'セ', 'ｿ': 'ソ',
        'ﾀ': 'タ', 'ﾁ': 'チ', 'ﾂ': 'ツ', 'ﾃ': 'テ', 'ﾄ': 'ト',
        'ﾅ': 'ナ', 'ﾆ': 'ニ', 'ﾇ': 'ヌ', 'ﾈ': 'ネ', 'ﾉ': 'ノ',
        'ﾊ': 'ハ', 'ﾋ': 'ヒ', 'ﾌ': 'フ', 'ﾍ': 'ヘ', 'ﾎ': 'ホ',
        'ﾏ': 'マ', 'ﾐ': 'ミ', 'ﾑ': 'ム', 'ﾒ': 'メ', 'ﾓ': 'モ',
        'ﾔ': 'ヤ', 'ﾕ': 'ユ', 'ﾖ': 'ヨ',
        'ﾗ': 'ラ', 'ﾘ': 'リ', 'ﾙ': 'ル', 'ﾚ': 'レ', 'ﾛ': 'ロ',
        'ﾜ': 'ワ', 'ﾝ': 'ン', 'ﾞ': '゛', 'ﾟ': '゜'
      };
      result = result.replace(/[ｦ-ﾟ]/g, function(s) {
        return halfToFull[s] || s;
      });

      return result;
    }

    // 漢字が含まれているかチェック
    function containsKanji(text) {
      return /[\u4e00-\u9faf]/.test(text);
    }

    // カタカナを正規化
    function normalizeKana(text) {
      const smallToLarge = {
        'ァ': 'ア', 'ィ': 'イ', 'ゥ': 'ウ', 'ェ': 'エ', 'ォ': 'オ',
        'ヵ': 'カ', 'ヶ': 'ケ', 'ャ': 'ヤ', 'ュ': 'ユ', 'ョ': 'ヨ',
        'ヮ': 'ワ', 'ッ': 'ツ'
      };

      return text.replace(/[ァィゥェォヵヶャュョヮッ]/g, function(match) {
        return smallToLarge[match] || match;
      });
    }

    // 銀行検索
    function searchBanks(keyword) {
      const results = document.getElementById('bankResults');

      if (!keyword || keyword.length < 1) {
        results.classList.remove('show');
        return;
      }

      // 検索キーワードを正規化（全角カナに統一）
      const normalizedKeyword = normalizeForSearch(keyword);
      const normalizedKeywordSmall = normalizeKana(normalizedKeyword);

      const filtered = banksCache.filter(bank => {
        const normalizedBankKana = normalizeForSearch(bank.kana || '');
        const normalizedBankKanaSmall = normalizeKana(normalizedBankKana);
        // 前方一致検索
        return bank.name.startsWith(keyword) ||
          normalizedBankKana.startsWith(normalizedKeyword) ||
          normalizedBankKanaSmall.startsWith(normalizedKeywordSmall);
      });

      if (filtered.length === 0) {
        results.innerHTML = '<div class="no-results">該当する銀行が見つかりません<br><small>カナで入力してください（例：ミズホ）</small><br><small style="color: #888;">No results. Type in Katakana.</small></div>';
        results.classList.add('show');
        return;
      }

      let html = '';
      if (containsKanji(keyword)) {
        html += `
          <div style="background: #fff3e0; padding: 8px 16px; border-bottom: 1px solid #ff9800; font-size: 12px; color: #f57c00;">
            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
            カナで入力すると検索結果が出やすくなります
          </div>
        `;
      }

      html += filtered.slice(0, 20).map(bank => `
        <div class="search-result-item" onclick="selectBank('${bank.code}', '${escapeHtml(bank.name)}', '${escapeHtml(bank.kana)}')">
          <span class="result-code">${bank.code}</span>
          <span class="result-name">${escapeHtml(bank.name)}</span>
          <span class="result-kana">${escapeHtml(bank.kana)}</span>
        </div>
      `).join('');

      results.innerHTML = html;
      results.classList.add('show');
    }

    // 銀行選択
    function selectBank(code, name, kana) {
      selectedBank = { code, name, kana };
      document.getElementById('bankSearch').value = name;
      document.getElementById('bankResults').classList.remove('show');

      // ゆうちょ銀行アラートの表示制御
      const yuuchoAlert = document.getElementById('yuuchoAlert');
      if (code === '9900') {
        yuuchoAlert.style.display = 'block';
      } else {
        yuuchoAlert.style.display = 'none';
      }

      // 支店検索を有効化
      const branchSearch = document.getElementById('branchSearch');
      branchSearch.disabled = false;
      branchSearch.placeholder = '支店名を入力して検索';
      branchSearch.value = '';
      document.getElementById('branchHelp').innerHTML = 'カナで入力すると候補が表示されます<br><small style="color: #888;">Type in Katakana to see suggestions</small>';
      selectedBranch = null;

      // 支店データをプリロード
      loadBranches(code);

      validateForm();
      autoSave();
    }

    // 支店検索
    async function searchBranches(keyword) {
      const results = document.getElementById('branchResults');

      if (!selectedBank) {
        results.classList.remove('show');
        return;
      }

      if (!keyword || keyword.length < 1) {
        results.classList.remove('show');
        return;
      }

      const branches = await loadBranches(selectedBank.code);
      const normalizedKeyword = normalizeKana(keyword);

      // 前方一致検索
      const normalizedKeywordFull = normalizeForSearch(keyword);
      const filtered = branches.filter(branch => {
        const normalizedBranchKana = normalizeForSearch(branch.kana || '');
        return branch.name.startsWith(keyword) ||
          normalizedBranchKana.startsWith(normalizedKeywordFull) ||
          normalizeKana(normalizedBranchKana).startsWith(normalizedKeyword);
      });

      if (filtered.length === 0) {
        results.innerHTML = '<div class="no-results">該当する支店が見つかりません<br><small>カナで入力してください（例：トウキヨウ）</small><br><small style="color: #888;">No results. Type in Katakana.</small></div>';
        results.classList.add('show');
        return;
      }

      let html = '';
      if (containsKanji(keyword)) {
        html += `
          <div style="background: #fff3e0; padding: 8px 16px; border-bottom: 1px solid #ff9800; font-size: 12px; color: #f57c00;">
            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
            カナで入力すると検索結果が出やすくなります
          </div>
        `;
      }

      html += filtered.slice(0, 20).map(branch => `
        <div class="search-result-item" onclick="selectBranch('${branch.code}', '${escapeHtml(branch.name)}', '${escapeHtml(branch.kana)}')">
          <span class="result-code">${branch.code}</span>
          <span class="result-name">${escapeHtml(branch.name)}</span>
          <span class="result-kana">${escapeHtml(branch.kana)}</span>
        </div>
      `).join('');

      results.innerHTML = html;
      results.classList.add('show');
    }

    // 支店選択
    function selectBranch(code, name, kana) {
      selectedBranch = { code, name, kana };
      document.getElementById('branchSearch').value = name;
      document.getElementById('branchResults').classList.remove('show');

      validateForm();
      autoSave();
    }

    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // バリデーション
    function validateForm() {
      const email = document.getElementById('email').value;
      const accountNumber = document.getElementById('accountNumber').value;
      const accountName = document.getElementById('accountName').value;
      const consent = document.getElementById('consent').checked;

      let isValid = true;

      if (!email || !validateEmail(email)) {
        isValid = false;
      }

      if (!selectedBank || !selectedBranch) {
        isValid = false;
      }

      if (!accountNumber || accountNumber.length !== 7) {
        isValid = false;
      }

      if (!accountName || !validateKana(accountName)) {
        isValid = false;
      }

      if (!consent) {
        isValid = false;
      }

      document.getElementById('confirmButton').disabled = !isValid;
      return isValid;
    }

    // メールアドレスバリデーション
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // カナバリデーション
    function validateKana(text) {
      const re = /^[ァ-ヶー 　]+$/;
      return re.test(text);
    }

    // 自動保存
    let autoSaveTimeout;
    function autoSave() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        const data = {
          token: TOKEN,
          email: document.getElementById('email').value,
          bankCode: selectedBank?.code,
          bankName: selectedBank?.name,
          branchCode: selectedBranch?.code,
          branchName: selectedBranch?.name,
          accountType: document.querySelector('input[name="accountType"]:checked')?.value,
          accountNumber: document.getElementById('accountNumber').value,
          accountName: document.getElementById('accountName').value,
        };

        localStorage.setItem('customerFormData_' + TOKEN, JSON.stringify(data));

        const indicator = document.getElementById('autosaveIndicator');
        indicator.classList.add('show');
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 2000);
      }, 1000);
    }

    // データ復元
    function restoreFormData() {
      const saved = localStorage.getItem('customerFormData_' + TOKEN);
      if (!saved) return;

      try {
        const data = JSON.parse(saved);

        if (data.email) document.getElementById('email').value = data.email;
        if (data.bankCode && data.bankName) {
          selectBank(data.bankCode, data.bankName, '');
        }
        if (data.branchCode && data.branchName) {
          setTimeout(() => {
            selectBranch(data.branchCode, data.branchName, '');
          }, 100);
        }
        if (data.accountType) {
          document.querySelector(`input[name="accountType"][value="${data.accountType}"]`).checked = true;
        }
        if (data.accountNumber) document.getElementById('accountNumber').value = data.accountNumber;
        if (data.accountName) document.getElementById('accountName').value = data.accountName;

        validateForm();
      } catch (e) {
        console.error('Failed to restore form data:', e);
      }
    }

    // スペースが含まれているかチェック
    function hasSpace(text) {
      return /\s/.test(text);
    }

    // 確認画面表示
    function showConfirmation() {
      const accountNameField = document.getElementById('accountName');
      accountNameField.value = accountNameField.value.replace(/ /g, '　');

      formData = {
        name: receptionData.name,
        phone: receptionData.phone,
        amount: receptionData.amount,
        email: document.getElementById('email').value,
        bank: selectedBank,
        branch: selectedBranch,
        accountType: document.querySelector('input[name="accountType"]:checked').value,
        accountNumber: document.getElementById('accountNumber').value,
        accountName: accountNameField.value,
      };

      document.getElementById('confirmName').textContent = formData.name;
      document.getElementById('confirmPhone').textContent = formatPhoneNumber(formData.phone);
      document.getElementById('confirmEmail').textContent = formData.email;
      document.getElementById('confirmAmount').textContent = formData.amount.toLocaleString() + '円';
      document.getElementById('confirmBank').textContent = formData.bank.name;
      document.getElementById('confirmBranch').textContent = formData.branch.name;
      document.getElementById('confirmAccountType').textContent = formData.accountType === 'ordinary' ? '普通預金' : '当座預金';
      document.getElementById('confirmAccountNumber').textContent = formData.accountNumber;
      document.getElementById('confirmAccountName').textContent = formData.accountName;

      const warningBanner = document.getElementById('accountNameWarning');
      if (!hasSpace(formData.accountName)) {
        warningBanner.style.display = 'block';
      } else {
        warningBanner.style.display = 'none';
      }

      document.getElementById('inputSection').style.display = 'none';
      document.getElementById('confirmationSection').classList.add('show');

      document.getElementById('step1').classList.remove('active');
      document.getElementById('step1').classList.add('completed');
      document.getElementById('step2').classList.add('active');

      window.scrollTo(0, 0);
    }

    // 入力画面に戻る
    function backToInput() {
      document.getElementById('confirmationSection').classList.remove('show');
      document.getElementById('inputSection').style.display = 'block';

      document.getElementById('step1').classList.remove('completed');
      document.getElementById('step1').classList.add('active');
      document.getElementById('step2').classList.remove('active');

      window.scrollTo(0, 0);
    }

    // フォーム送信（Cloudflare Worker経由）
    function submitForm() {
      document.getElementById('confirmationSection').classList.remove('show');
      document.getElementById('loadingSection').classList.add('show');

      // localStorageクリア
      localStorage.removeItem('customerFormData_' + TOKEN);

      const fields = {
        token: TOKEN,
        email: formData.email,
        bankCode: formData.bank.code,
        bankName: formData.bank.name,
        branchCode: formData.branch.code,
        branchName: formData.branch.name,
        accountType: formData.accountType === 'ordinary' ? '普通' : '当座',
        accountNumber: formData.accountNumber,
        accountName: formData.accountName,
        external: 'true'
      };

      // Cloudflare Worker経由で送信
      const submitData = new FormData();
      for (const [key, value] of Object.entries(fields)) {
        submitData.append(key, value);
      }

      fetch(WORKER_URL + '/submit', {
        method: 'POST',
        body: submitData
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            showSubmitResult(true, '口座情報の登録が完了しました。<br>このページを閉じてください。<br><small style="color: #888;">Registration complete. You may close this page.</small>');
          } else {
            console.error('Submit failed:', data.error);
            showSubmitResult(false, 'エラーが発生しました。<br>しばらく経ってから再度お試しください。<br><small style="color: #888;">An error occurred. Please try again later.</small>');
          }
        })
        .catch(error => {
          console.error('Submit error:', error);
          // フォールバック：直接GASに送信を試みる（no-corsモード）
          submitDirectToGAS(fields);
        });
    }

    // 直接GASに送信（フォールバック）
    function submitDirectToGAS(fields) {
      const submitData = new FormData();
      for (const [key, value] of Object.entries(fields)) {
        submitData.append(key, value);
      }

      fetch(GAS_URL + '?path=external-form', {
        method: 'POST',
        mode: 'no-cors',
        body: submitData
      }).then(() => {
        showSubmitResult(true, '口座情報の登録が完了しました。<br>このページを閉じてください。<br><small style="color: #888;">Registration complete. You may close this page.</small>');
      }).catch(error => {
        console.error('Direct GAS submit error:', error);
        submitViaIframe(fields);
      });
    }

    // iframeによるフォールバック送信
    function submitViaIframe(fields) {
      const iframeName = 'submitFrame_' + Date.now();
      const iframe = document.createElement('iframe');
      iframe.name = iframeName;
      iframe.style.display = 'none';
      document.body.appendChild(iframe);

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = GAS_URL + '?path=external-form';
      form.target = iframeName;

      for (const [key, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
      }

      document.body.appendChild(form);

      const timeout = setTimeout(() => {
        showSubmitResult(true, '送信処理中です。しばらくお待ちください。<br><small style="color: #888;">Processing. Please wait...</small>');
        cleanup();
      }, 10000);

      iframe.onload = function() {
        clearTimeout(timeout);
        showSubmitResult(true, '口座情報の登録が完了しました。<br>このページを閉じてください。<br><small style="color: #888;">Registration complete. You may close this page.</small>');
        cleanup();
      };

      function cleanup() {
        setTimeout(() => {
          if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
          if (form.parentNode) form.parentNode.removeChild(form);
        }, 1000);
      }

      form.submit();
    }

    function showSubmitResult(success, message) {
      document.getElementById('loadingSection').classList.remove('show');

      const resultHtml = `
        <div class="container" style="text-align: center; padding: 48px 24px;">
          <div style="width: 80px; height: 80px; border-radius: 50%; background: ${success ? '#27ae60' : '#e74c3c'}; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 40px; color: white;">
            ${success ? '✓' : '✕'}
          </div>
          <h1 style="color: #333; margin-bottom: 16px; font-size: 24px;">${success ? '送信完了 / Submitted' : 'エラー / Error'}</h1>
          <p style="color: #666; line-height: 1.6;">${message}</p>
        </div>
      `;

      document.querySelector('.main').innerHTML = resultHtml;
      document.querySelector('.steps').style.display = 'none';
    }

    // 電話番号フォーマット
    function formatPhoneNumber(phone) {
      if (phone.length === 11) {
        return phone.slice(0, 3) + '-' + phone.slice(3, 7) + '-' + phone.slice(7);
      } else if (phone.length === 10) {
        return phone.slice(0, 3) + '-' + phone.slice(3, 6) + '-' + phone.slice(6);
      }
      return phone;
    }
  </script>
</body>
</html>
